import * as THREE from "three";
import * as MINDAR from "mindar_face";
import * as faceapi from "faceapi";
import {GLTFLoader} from "three/addons/loaders/GLTFLoader.js"


document.addEventListener("DOMContentLoaded", () => {

	const start = async() => {

		const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.3 });
		const path = "face-api/model";
		await faceapi.nets.ssdMobilenetv1.load(path);
		await faceapi.nets.tinyFaceDetector.load(path);
		await faceapi.nets.faceLandmark68Net.load(path);
		await faceapi.nets.faceExpressionNet.load(path);
		await faceapi.nets.ageGenderNet.load(path);

		const mindarThree = new MINDAR.MindARThree({
			container: document.body,
			uiLoading: "yes", uiScanning: "no", uiError: "no",
		      });

		const {renderer, scene, camera} = mindarThree;

		const anchor_s1 = mindarThree.addAnchor(10);

		const loader = new THREE.TextureLoader();

		const textures = {};
		textures["neutral"] = loader.load('assets/neutral.jpg');
		textures["surprised"] = loader.load('assets/surprised.png');
		textures["disgusted"] = loader.load('assets/disgusted.png');
		textures["fearful"] = loader.load('assets/fearful.png');
		textures["sad"] = loader.load('assets/sad.png');
		textures["angry"] = loader.load('assets/angry.png');
		textures["happy"] = loader.load('assets/happy.png');

		let last_expression = "neutral";

		var planegeometry=new THREE.PlaneGeometry(0.25, 0.25);
		var planematerial=new THREE.MeshBasicMaterial( {map: textures[last_expression]} );
		var planemesh=new THREE.Mesh(planegeometry, planematerial);
		planemesh.position.y = 0.3;

		anchor_s1.group.add(planemesh);

		var light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 2.5);
		scene.add(light);

		let skip = 1;
		await mindarThree.start();

		let video = mindarThree.video;

		const div_age=document.getElementById("age");

		const expressions = [
			"neutral",
			"happy",
			"sad",
			"angry",
			"fearful",
			"disgusted",
			"surprised"
		];
		

		renderer.setAnimationLoop(async () => {
			skip += 1;
			if(skip%10==0)
			{
				const result = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceExpressions().withAgeAndGender();
				console.log(result);
				let str=""
				if(result["gender"] == "male")
					str += "Стать: чоловіча ";
				else
					str += "Стать: жіноча ";
				str+= "(з імовірністю " + Math.round(100*result["genderProbability"])+ "%)<br>";
				str+= "Вік - " + Math.round(result["age"])+ " років";
				div_age.innerHTML=str;

				let new_expression = expressions[0];
				let new_expression_prob = result["expressions"][expressions[0]];
				
				for(let i=1;i<expressions.length;i++)
					if(result["expressions"][expressions[i]] > new_expression_prob)
					{
						new_expression = expressions[i];
						new_expression_prob = result["expressions"][expressions[i]];
					}
				//console.log(new_expression, new_expression_prob);
				if(last_expression != new_expression)
				{
					planemesh.material.map = textures[new_expression];
					last_expression = new_expression;
				}
			}
	  		renderer.render(scene, camera);
		});
	}

	start();
});


/*

{
    "detection": {
        "_imageDims": {
            "_width": 640,
            "_height": 480
        },
        "_score": 0.9922589063644409,
        "_classScore": 0.9922589063644409,
        "_className": "",
        "_box": {
            "_x": 256.1650085449219,
            "_y": 212.15065002441403,
            "_width": 205.65879821777344,
            "_height": 245.60768127441403
        }
    },
    "landmarks": {
        "_imgDims": {
            "_width": 205,
            "_height": 245
        },
        "_shift": {
            "_x": 256.1650085449219,
            "_y": 212.15065002441403
        },
        "_positions": [
            {
                "_x": 254.3968417774886,
                "_y": 294.96046006679535
            },
            {
                "_x": 257.46396812144667,
                "_y": 323.3142924308777
            },
            {
                "_x": 262.80474439263344,
                "_y": 349.60208743810654
            },
            {
                "_x": 268.03123470395803,
                "_y": 371.62648171186447
            },
            {
                "_x": 276.34598422795534,
                "_y": 395.93990325927734
            },
            {
                "_x": 290.08890703320503,
                "_y": 415.3119733929634
            },
            {
                "_x": 306.51350036263466,
                "_y": 429.53452438116074
            },
            {
                "_x": 328.933145403862,
                "_y": 443.1637352705002
            },
            {
                "_x": 361.8149200081825,
                "_y": 450.0085034966469
            },
            {
                "_x": 392.9178351163864,
                "_y": 441.30152851343155
            },
            {
                "_x": 412.00592786073685,
                "_y": 429.2004629969597
            },
            {
                "_x": 426.9545328617096,
                "_y": 416.9032481312752
            },
            {
                "_x": 440.42657524347305,
                "_y": 396.466244161129
            },
            {
                "_x": 450.2016392350197,
                "_y": 372.79876321554184
            },
            {
                "_x": 455.474813580513,
                "_y": 350.5549421906471
            },
            {
                "_x": 460.16777098178864,
                "_y": 325.90515926480293
            },
            {
                "_x": 461.7643481492996,
                "_y": 298.9538414776325
            },
            {
                "_x": 278.76735899597406,
                "_y": 280.14675945043564
            },
            {
                "_x": 291.86007775366306,
                "_y": 274.31167408823967
            },
            {
                "_x": 307.4639271199703,
                "_y": 273.5121814906597
            },
            {
                "_x": 321.831539273262,
                "_y": 275.21725848317146
            },
            {
                "_x": 334.517377614975,
                "_y": 279.4471304118633
            },
            {
                "_x": 385.67937672138214,
                "_y": 279.89787086844444
            },
            {
                "_x": 397.85523265600204,
                "_y": 276.0627217590809
            },
            {
                "_x": 411.9841781258583,
                "_y": 274.3643622100353
            },
            {
                "_x": 427.74680972099304,
                "_y": 275.9560604393482
            },
            {
                "_x": 439.26714330911636,
                "_y": 280.8284631371498
            },
            {
                "_x": 360.2080178260803,
                "_y": 307.12545081973076
            },
            {
                "_x": 360.5794617533684,
                "_y": 326.99065431952477
            },
            {
                "_x": 360.31936913728714,
                "_y": 346.77432119846344
            },
            {
                "_x": 359.65317964553833,
                "_y": 363.20257395505905
            },
            {
                "_x": 344.49649810791016,
                "_y": 371.3619166612625
            },
            {
                "_x": 351.4684733748436,
                "_y": 374.4135782122612
            },
            {
                "_x": 360.07737278938293,
                "_y": 376.59055560827255
            },
            {
                "_x": 369.46448504924774,
                "_y": 374.03274297714233
            },
            {
                "_x": 376.6552773118019,
                "_y": 371.97960019111633
            },
            {
                "_x": 299.0328623354435,
                "_y": 298.7810206413269
            },
            {
                "_x": 308.74486431479454,
                "_y": 296.4151808619499
            },
            {
                "_x": 321.1239030957222,
                "_y": 295.9955231845379
            },
            {
                "_x": 332.5508289039135,
                "_y": 302.42262706160545
            },
            {
                "_x": 322.9063305258751,
                "_y": 306.4889073371887
            },
            {
                "_x": 309.3307691812515,
                "_y": 305.2722615003586
            },
            {
                "_x": 386.5644443035126,
                "_y": 302.2825537621975
            },
            {
                "_x": 398.34748536348343,
                "_y": 295.76818883419037
            },
            {
                "_x": 411.2000146508217,
                "_y": 296.32860615849495
            },
            {
                "_x": 419.9172595143318,
                "_y": 300.72351545095444
            },
            {
                "_x": 410.75981467962265,
                "_y": 306.4043989777565
            },
            {
                "_x": 397.15501338243484,
                "_y": 305.4292671382427
            },
            {
                "_x": 327.2058682143688,
                "_y": 404.7632944583893
            },
            {
                "_x": 339.8337398469448,
                "_y": 401.8394395709038
            },
            {
                "_x": 353.2441681623459,
                "_y": 398.6431047320366
            },
            {
                "_x": 360.35813987255096,
                "_y": 400.24883657693863
            },
            {
                "_x": 367.18670129776,
                "_y": 398.3351683616638
            },
            {
                "_x": 382.2270828485489,
                "_y": 403.5402962565422
            },
            {
                "_x": 394.68304604291916,
                "_y": 405.7148203253746
            },
            {
                "_x": 383.25205743312836,
                "_y": 414.5613721013069
            },
            {
                "_x": 372.96377301216125,
                "_y": 420.04803389310837
            },
            {
                "_x": 361.0922545194626,
                "_y": 421.21778905391693
            },
            {
                "_x": 350.3328500688076,
                "_y": 419.71963852643967
            },
            {
                "_x": 338.36499735713005,
                "_y": 415.10162979364395
            },
            {
                "_x": 328.88609021902084,
                "_y": 405.29360741376877
            },
            {
                "_x": 349.84724447131157,
                "_y": 406.4554914832115
            },
            {
                "_x": 360.4395791888237,
                "_y": 406.50400310754776
            },
            {
                "_x": 370.55893659591675,
                "_y": 406.70936703681946
            },
            {
                "_x": 391.95417523384094,
                "_y": 405.70624828338623
            },
            {
                "_x": 371.58992290496826,
                "_y": 408.78784626722336
            },
            {
                "_x": 361.53824627399445,
                "_y": 409.75339114665985
            },
            {
                "_x": 350.9761106967926,
                "_y": 408.93948525190353
            }
        ]
    },
    "unshiftedLandmarks": {
        "_imgDims": {
            "_width": 205,
            "_height": 245
        },
        "_shift": {
            "_x": 0,
            "_y": 0
        },
        "_positions": [
            {
                "_x": -1.7681667674332857,
                "_y": 82.80981004238129
            },
            {
                "_x": 1.298959576524794,
                "_y": 111.16364240646362
            },
            {
                "_x": 6.639735847711563,
                "_y": 137.45143741369247
            },
            {
                "_x": 11.86622615903616,
                "_y": 159.4758316874504
            },
            {
                "_x": 20.180975683033466,
                "_y": 183.78925323486328
            },
            {
                "_x": 33.92389848828316,
                "_y": 203.16132336854935
            },
            {
                "_x": 50.348491817712784,
                "_y": 217.38387435674667
            },
            {
                "_x": 72.76813685894012,
                "_y": 231.01308524608612
            },
            {
                "_x": 105.64991146326065,
                "_y": 237.85785347223282
            },
            {
                "_x": 136.75282657146454,
                "_y": 229.1508784890175
            },
            {
                "_x": 155.84091931581497,
                "_y": 217.04981297254562
            },
            {
                "_x": 170.78952431678772,
                "_y": 204.75259810686111
            },
            {
                "_x": 184.26156669855118,
                "_y": 184.31559413671494
            },
            {
                "_x": 194.0366306900978,
                "_y": 160.64811319112778
            },
            {
                "_x": 199.30980503559113,
                "_y": 138.40429216623306
            },
            {
                "_x": 204.00276243686676,
                "_y": 113.75450924038887
            },
            {
                "_x": 205.59933960437775,
                "_y": 86.80319145321846
            },
            {
                "_x": 22.60235045105219,
                "_y": 67.99610942602158
            },
            {
                "_x": 35.69506920874119,
                "_y": 62.16102406382561
            },
            {
                "_x": 51.29891857504845,
                "_y": 61.36153146624565
            },
            {
                "_x": 65.66653072834015,
                "_y": 63.0666084587574
            },
            {
                "_x": 78.3523690700531,
                "_y": 67.29648038744926
            },
            {
                "_x": 129.51436817646027,
                "_y": 67.74722084403038
            },
            {
                "_x": 141.69022411108017,
                "_y": 63.912071734666824
            },
            {
                "_x": 155.81916958093643,
                "_y": 62.21371218562126
            },
            {
                "_x": 171.58180117607117,
                "_y": 63.80541041493416
            },
            {
                "_x": 183.1021347641945,
                "_y": 68.67781311273575
            },
            {
                "_x": 104.04300928115845,
                "_y": 94.9748007953167
            },
            {
                "_x": 104.4144532084465,
                "_y": 114.8400042951107
            },
            {
                "_x": 104.15436059236526,
                "_y": 134.62367117404938
            },
            {
                "_x": 103.48817110061646,
                "_y": 151.051923930645
            },
            {
                "_x": 88.33148956298828,
                "_y": 159.21126663684845
            },
            {
                "_x": 95.30346482992172,
                "_y": 162.26292818784714
            },
            {
                "_x": 103.91236424446106,
                "_y": 164.4399055838585
            },
            {
                "_x": 113.29947650432587,
                "_y": 161.88209295272827
            },
            {
                "_x": 120.49026876688004,
                "_y": 159.82895016670227
            },
            {
                "_x": 42.86785379052162,
                "_y": 86.63037061691284
            },
            {
                "_x": 52.579855769872665,
                "_y": 84.26453083753586
            },
            {
                "_x": 64.95889455080032,
                "_y": 83.84487316012383
            },
            {
                "_x": 76.38582035899162,
                "_y": 90.27197703719139
            },
            {
                "_x": 66.74132198095322,
                "_y": 94.33825731277466
            },
            {
                "_x": 53.16576063632965,
                "_y": 93.12161147594452
            },
            {
                "_x": 130.3994357585907,
                "_y": 90.13190373778343
            },
            {
                "_x": 142.18247681856155,
                "_y": 83.6175388097763
            },
            {
                "_x": 155.0350061058998,
                "_y": 84.17795613408089
            },
            {
                "_x": 163.75225096940994,
                "_y": 88.57286542654037
            },
            {
                "_x": 154.59480613470078,
                "_y": 94.25374895334244
            },
            {
                "_x": 140.99000483751297,
                "_y": 93.27861711382866
            },
            {
                "_x": 71.04085966944695,
                "_y": 192.61264443397522
            },
            {
                "_x": 83.66873130202293,
                "_y": 189.68878954648972
            },
            {
                "_x": 97.07915961742401,
                "_y": 186.49245470762253
            },
            {
                "_x": 104.19313132762909,
                "_y": 188.09818655252457
            },
            {
                "_x": 111.02169275283813,
                "_y": 186.18451833724976
            },
            {
                "_x": 126.06207430362701,
                "_y": 191.38964623212814
            },
            {
                "_x": 138.51803749799728,
                "_y": 193.56417030096054
            },
            {
                "_x": 127.08704888820648,
                "_y": 202.41072207689285
            },
            {
                "_x": 116.79876446723938,
                "_y": 207.8973838686943
            },
            {
                "_x": 104.92724597454071,
                "_y": 209.06713902950287
            },
            {
                "_x": 94.16784152388573,
                "_y": 207.5689885020256
            },
            {
                "_x": 82.19998881220818,
                "_y": 202.9509797692299
            },
            {
                "_x": 72.72108167409897,
                "_y": 193.1429573893547
            },
            {
                "_x": 93.6822359263897,
                "_y": 194.30484145879745
            },
            {
                "_x": 104.27457064390182,
                "_y": 194.3533530831337
            },
            {
                "_x": 114.39392805099487,
                "_y": 194.5587170124054
            },
            {
                "_x": 135.78916668891907,
                "_y": 193.55559825897217
            },
            {
                "_x": 115.42491436004639,
                "_y": 196.6371962428093
            },
            {
                "_x": 105.37323772907257,
                "_y": 197.6027411222458
            },
            {
                "_x": 94.81110215187073,
                "_y": 196.78883522748947
            }
        ]
    },
    "alignedRect": {
        "_imageDims": {
            "_width": 640,
            "_height": 480
        },
        "_score": 0.9922589063644409,
        "_classScore": 0.9922589063644409,
        "_className": "",
        "_box": {
            "_x": 233.6600911403075,
            "_y": 255.862549290061,
            "_width": 248.84100764617327,
            "_height": 211.7955864071846
        }
    },
    "angle": {
        "roll": 0,
        "pitch": -3,
        "yaw": -2
    },
    "expressions": {
        "neutral": 0.9813466668128967,
        "happy": 0.0038258186541497707,
        "sad": 0.0010174978524446487,
        "angry": 0.008929767645895481,
        "fearful": 0.0007629343890585005,
        "disgusted": 0.0008243005140684545,
        "surprised": 0.003293056972324848
    },
    "gender": "male",
    "genderProbability": 0.9754478931427002,
    "age": 44.191829681396484
}
*/
